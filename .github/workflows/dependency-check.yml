name: Dependency Check

on:
  # é€±æ¬¡å®Ÿè¡Œï¼ˆæ—¥æ›œ 23:00 JST = UTC 14:00ï¼‰
  schedule:
    - cron: '0 14 * * 0'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dependency-check:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6

      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯
      - name: npm outdated ãƒã‚§ãƒƒã‚¯
        id: outdated
        run: |
          echo "## ðŸ“¦ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm outdated --long > outdated.txt 2>&1; then
            echo "âœ… ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒæœ€æ–°ã§ã™" >> $GITHUB_STEP_SUMMARY
          else
            echo "ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat outdated.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ãƒã‚§ãƒƒã‚¯
      - name: npm audit ãƒã‚§ãƒƒã‚¯
        id: audit
        run: |
          echo "## ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm audit --json > audit.json 2>&1; then
            echo "âœ… æ—¢çŸ¥ã®è„†å¼±æ€§ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            # è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
            echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # è„†å¼±æ€§ã®ã‚µãƒžãƒªãƒ¼ã‚’è¡¨ç¤º
            npm audit --audit-level=none || true
            npm audit >> $GITHUB_STEP_SUMMARY || true

            # é«˜ãƒªã‚¹ã‚¯ä»¥ä¸Šã®è„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Š
            HIGH_COUNT=$(jq -r '.metadata.vulnerabilities.high // 0' audit.json)
            CRITICAL_COUNT=$(jq -r '.metadata.vulnerabilities.critical // 0' audit.json)

            if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **è­¦å‘Š**: é«˜ãƒªã‚¹ã‚¯ä»¥ä¸Šã®è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆé«˜: $HIGH_COUNT, å±é™º: $CRITICAL_COUNTï¼‰" >> $GITHUB_STEP_SUMMARY
              echo "é€Ÿã‚„ã‹ã«å¯¾å¿œã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      # ä¾å­˜é–¢ä¿‚ã®çµ±è¨ˆæƒ…å ±
      - name: ä¾å­˜é–¢ä¿‚ã®çµ±è¨ˆ
        run: |
          echo "## ðŸ“Š ä¾å­˜é–¢ä¿‚ã®çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # package.json ã‹ã‚‰ä¾å­˜é–¢ä¿‚ã®æ•°ã‚’å–å¾—
          DEPS_COUNT=$(jq -r '.dependencies | length' package.json)
          DEVDEPS_COUNT=$(jq -r '.devDependencies | length' package.json)

          echo "- **dependencies**: $DEPS_COUNT å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **devDependencies**: $DEVDEPS_COUNT å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆè¨ˆ**: $((DEPS_COUNT + DEVDEPS_COUNT)) å€‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # lockfileã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      - name: lockfile æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        run: |
          echo "## ðŸ” lockfile æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm ci --dry-run > /dev/null 2>&1; then
            echo "âœ… package-lock.json ã¯æ­£å¸¸ã§ã™" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ package-lock.json ã«å•é¡ŒãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      # æœ€çµ‚æ›´æ–°æ—¥æ™‚
      - name: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ—¥æ™‚
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ—¥æ™‚**: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
